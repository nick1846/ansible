---

- name: Install packages
  yum: 
    enablerepo: "{{ repo_name }}" 
    name: "{{ packages }}" 
    state: present


- name: Open firewall port for service
  become: yes
  firewalld:
    service: "{{ firewall_service }}" 
    zone: public
    immediate: yes # this is the firewall-cmd --reload
    permanent: true
    state: enabled


- name: Check if database is already initialized  
  stat:
    path: "/var/lib/pgsql/12/data/PG_VERSION"
  register: init_status


- name: Initialize the master database  
  shell: /usr/pgsql-12/bin/postgresql-12-setup initdb
  when: init_status.stat.exists == False

  
- name: Start and enable service  
  service:
    name: "{{ service_name }}" 
    state: started
    enabled: yes
  when: init_status.stat.exists == True


- name: Add new configuration to "postgresql.conf" - listen All  
  blockinfile:
    create: yes
    dest: /var/lib/pgsql/12/data/postgresql.conf
    block: |
      listen_addresses = '*'
      

- name: Add new configuration to "pg_hba.conf" - enable the remote connection to the server  
  blockinfile:
    dest: /var/lib/pgsql/12/data/pg_hba.conf
    block: |
      host    all             all             0.0.0.0/0                md5
  notify: Restart service
  
    
- name: Include task to create PG_roles and PG_databases
  include: databases.yaml
  


      

    

